#!/bin/bash
#
# Find all executable files that were generated by the SERIF build,
# and copy them to the install directory.

set -e # Exit immediately if any simple command fails.
set -u # Treat unset variables as an error.

export BUILD_DIR="+build_dir+"
export INSTALL_DIR="+install_dir+"
export EXTERNAL_LIB="+external_lib+"
export ARCHITECTURE="+architecture+"

mkdir -p $INSTALL_DIR
cd $BUILD_DIR

# The following find commands copy the appropriate binaries to the 
# install directory, preserving the relative path where they were
# found.  The mkdir/rmdir lines are just there to make sure that the
# target directory exists before we run the cp command. 
# the mkdir/rmdir combo works by creating a dir named what the file
# will be named, plus all the dir path leading to it. The rmdir removes
# the fake dir so the copy fills in a file of that name, so this is safe
# if a second invocation treated the same sequence of directories with a 
# new file name.  rmdir could matter rather badly if find were
# returning directories, but we restrict it to paths ending in file.
# (Note that
# {}, the filename found by find, will contain subdirectories.)
if [ "$ARCHITECTURE" == "Win32" -o "$ARCHITECTURE" == "Win64" ]; then
    # Copy any file that ends in '.exe'
    find . -type f -name '*.exe' \
	-exec echo {} \; \
	-exec mkdir -p $INSTALL_DIR/{} \; \
	-exec rmdir  $INSTALL_DIR/{} \; \
	-exec cp {} $INSTALL_DIR/{} \; 
    # Copy the Xerces files as well
    find . -type f -name 'xerces*' \
	-exec echo {} \; \
	-exec mkdir -p $INSTALL_DIR/{} \; \
	-exec rmdir  $INSTALL_DIR/{} \; \
	-exec cp {} $INSTALL_DIR/{} \;  
    # Copy any external lib dll files 
	if [ -n "$EXTERNAL_LIB" ]; then
		pushd "$EXTERNAL_LIB"
		find . -type f -name '*.dll' \
			-exec echo {} \; \
			-exec cp {} $INSTALL_DIR/SerifMain/Release/{} \; 
		popd
	fi	
else
    # Copy any file that is executable (a+x) and does not have any
    # file extension (eg .out or .bin).
    find . -type f -perm +"a+x" ! -name '*.*' \
	-exec echo {} \; \
	-exec mkdir -p $INSTALL_DIR/{} \; \
	-exec rmdir  $INSTALL_DIR/{} \; \
	-exec cp {} $INSTALL_DIR/{} \; 
    # Copy shared library files
    find . -type f -name '*.so' \
	-exec echo {} \; \
	-exec mkdir -p $INSTALL_DIR/{} \; \
	-exec rmdir  $INSTALL_DIR/{} \; \
	-exec cp {} $INSTALL_DIR/{} \; 
fi
